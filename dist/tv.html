<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Game Master - Vista TV</title>

        <!-- Inter Font -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
            rel="stylesheet"
        />

        <!-- Google Cast API intentionally disabled to enforce Chrome Mirroring flow -->

        <style>
            /* CSS Variables - Design System */
            :root {
                /* Background Colors */
                --primary-bg: linear-gradient(
                    135deg,
                    #0a0e27 0%,
                    #1a1f3a 50%,
                    #2d3561 100%
                );
                --surface-bg: rgba(255, 255, 255, 0.05);
                --glass-bg: rgba(255, 255, 255, 0.08);
                --card-bg: rgba(255, 255, 255, 0.1);

                /* Text Colors */
                --text-primary: #ffffff;
                --text-secondary: #b8c5d6;
                --text-muted: #8892b0;
                --text-accent: #64d9ff;

                /* Accent Colors */
                --accent-blue: #64d9ff;
                --accent-purple: #9d7cff;
                --accent-green: #4ade80;
                --accent-orange: #ff8c42;
                --accent-red: #ff5757;
                --accent-yellow: #ffa502;

                /* Gradients */
                --gradient-primary: linear-gradient(
                    135deg,
                    #64d9ff 0%,
                    #9d7cff 100%
                );
                --gradient-accent: linear-gradient(
                    135deg,
                    #9d7cff 0%,
                    #64d9ff 100%
                );
                --gradient-card: linear-gradient(
                    135deg,
                    rgba(255, 255, 255, 0.12) 0%,
                    rgba(255, 255, 255, 0.08) 100%
                );

                /* Shadows */
                --shadow-sm:
                    0 2px 4px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
                --shadow-md:
                    0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
                --shadow-lg:
                    0 10px 15px rgba(0, 0, 0, 0.1),
                    0 4px 6px rgba(0, 0, 0, 0.05);
                --shadow-glow: 0 0 20px rgba(100, 217, 255, 0.15);

                /* Border Radius */
                --radius-sm: 0.375rem;
                --radius-md: 0.5rem;
                --radius-lg: 0.75rem;
                --radius-xl: 1rem;

                /* Spacing */
                --space-xs: 0.25rem;
                --space-sm: 0.5rem;
                --space-md: 0.75rem;
                --space-lg: 1rem;
                --space-xl: 1.5rem;
                --space-2xl: 2rem;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    sans-serif;
                background: var(--primary-bg);
                color: var(--text-primary);
                height: 100vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                position: relative;
            }

            /* Animated background pattern */
            body::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background:
                    radial-gradient(
                        circle at 20% 80%,
                        rgba(100, 217, 255, 0.08) 0%,
                        transparent 50%
                    ),
                    radial-gradient(
                        circle at 80% 20%,
                        rgba(157, 124, 255, 0.08) 0%,
                        transparent 50%
                    ),
                    radial-gradient(
                        circle at 40% 40%,
                        rgba(74, 222, 128, 0.05) 0%,
                        transparent 50%
                    );
                animation: backgroundShift 20s ease-in-out infinite;
                pointer-events: none;
            }

            @keyframes backgroundShift {
                0%,
                100% {
                    transform: translate(0, 0) scale(1);
                }
                33% {
                    transform: translate(-10px, -10px) scale(1.02);
                }
                66% {
                    transform: translate(10px, 10px) scale(0.98);
                }
            }

            .tv-container {
                height: 100vh;
                display: flex;
                flex-direction: column;
                position: relative;
                z-index: 1;
            }

            .tv-header {
                background: var(--glass-bg);
                backdrop-filter: blur(20px);
                padding: var(--space-2xl);
                text-align: center;
                border-bottom: 2px solid rgba(255, 255, 255, 0.15);
                box-shadow: var(--shadow-md);
                position: relative;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: var(--space-md);
            }

            .tv-header::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--gradient-card);
                opacity: 0.6;
                pointer-events: none;
            }

            .tv-header h1 {
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 0;
                background: var(--gradient-primary);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                position: relative;
                z-index: 1;
                letter-spacing: -0.025em;
            }

            .casting-status {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: var(--space-sm);
                margin-top: 0;
                position: relative;
                z-index: 1;
            }

            .status-dot {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: var(--accent-red);
                box-shadow: 0 0 8px var(--accent-red);
                transition: all 0.3s ease;
            }

            .status-dot.connected {
                background: var(--accent-green);
                box-shadow: 0 0 12px var(--accent-green);
                animation: pulse 2s infinite;
            }

            .status-text {
                font-size: 0.875rem;
                font-weight: 600;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 0.025em;
                transition: color 0.3s ease;
            }

            .status-dot.connected + .status-text {
                color: var(--accent-green);
            }

            @keyframes pulse {
                0%,
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.1);
                    opacity: 0.8;
                }
            }

            .room-info {
                font-size: 1.125rem;
                color: var(--text-secondary);
                font-weight: 500;
                position: relative;
                z-index: 1;
            }

            .main-display {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                padding: var(--space-2xl);
            }

            .timer-display {
                text-align: center;
                position: relative;
                background: var(--glass-bg);
                backdrop-filter: blur(15px);
                border-radius: var(--radius-xl);
                padding: var(--space-2xl);
                border: 1px solid rgba(255, 255, 255, 0.15);
                box-shadow: var(--shadow-lg);
            }

            .time-text {
                font-family: "Inter", monospace;
                font-size: 8rem;
                font-weight: 800;
                margin-bottom: var(--space-2xl);
                transition: all 0.3s ease;
                letter-spacing: -0.02em;
                position: relative;
            }

            /* TV optimized styles for better visibility when cast */
            @media screen and (min-width: 1280px) {
                .time-text {
                    font-size: 10rem;
                    text-shadow:
                        0 0 30px currentColor,
                        0 4px 8px rgba(0, 0, 0, 0.3);
                }

                .tv-header h1 {
                    font-size: 3.5rem;
                    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                }

                .room-info {
                    font-size: 1.5rem;
                }

                .hints-display {
                    transform: scale(1.2);
                    margin: var(--space-xl) 0;
                }

                .notification-overlay {
                    top: 10%;
                    left: 5%;
                    right: 5%;
                    padding: var(--space-2xl) var(--space-2xl);
                }

                .notification-header {
                    font-size: 3rem;
                }

                .notification-content {
                    font-size: 2rem;
                    line-height: 1.4;
                }
            }

            .time-low {
                color: var(--accent-red);
                text-shadow: 0 0 30px var(--accent-red);
                animation: pulseGlow 2s infinite;
            }

            .time-warning {
                color: var(--accent-orange);
                text-shadow: 0 0 25px var(--accent-orange);
            }

            .time-normal {
                color: var(--accent-blue);
                text-shadow: 0 0 20px var(--accent-blue);
            }

            @keyframes pulseGlow {
                0%,
                100% {
                    opacity: 1;
                    transform: scale(1);
                    text-shadow:
                        0 0 30px currentColor,
                        0 0 60px currentColor;
                }
                50% {
                    opacity: 0.8;
                    transform: scale(1.02);
                    text-shadow:
                        0 0 40px currentColor,
                        0 0 80px currentColor;
                }
            }

            .status-bar {
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 1.5rem;
                margin-top: var(--space-lg);
            }

            .hints-display {
                display: flex;
                align-items: center;
                gap: var(--space-md);
                background: var(--surface-bg);
                padding: var(--space-md) var(--space-lg);
                border-radius: var(--radius-lg);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .hint-icon {
                font-size: 1.25rem;
                margin-right: var(--space-sm);
            }

            .hint-dot {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: var(--accent-green);
                border: 2px solid rgba(255, 255, 255, 0.8);
                transition: all 0.3s ease;
                box-shadow: 0 0 6px rgba(74, 222, 128, 0.4);
            }

            .hint-dot.used {
                background: rgba(255, 255, 255, 0.15);
                border-color: rgba(255, 255, 255, 0.3);
                box-shadow: none;
            }

            .hint-dot.penalty {
                border-color: var(--accent-orange);
                box-shadow: 0 0 6px rgba(255, 140, 66, 0.4);
            }

            .footer-bar {
                background: var(--glass-bg);
                backdrop-filter: blur(20px);
                padding: var(--space-xl) var(--space-2xl);
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-top: 1px solid rgba(255, 255, 255, 0.15);
                box-shadow: var(--shadow-md);
                position: relative;
            }

            .sound-toggle {
                position: absolute;
                right: var(--space-2xl);
                top: 50%;
                transform: translateY(-50%);
                background: var(--glass-bg);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: var(--radius-md);
                padding: var(--space-sm);
                color: var(--text-primary);
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 1.25rem;
                width: 44px;
                height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
                box-shadow: var(--shadow-sm);
            }

            .sound-toggle:hover {
                background: rgba(100, 217, 255, 0.1);
                border-color: var(--accent-blue);
                transform: translateY(-50%) scale(1.05);
                box-shadow: var(--shadow-md);
            }

            .sound-toggle.muted {
                background: rgba(255, 87, 87, 0.1);
                border-color: var(--accent-red);
                color: var(--accent-red);
            }

            .sound-toggle.muted:hover {
                background: rgba(255, 87, 87, 0.2);
            }



            .connection-status {
                display: flex;
                align-items: center;
                gap: var(--space-md);
                font-size: 1rem;
                font-weight: 500;
                background: var(--surface-bg);
                padding: var(--space-sm) var(--space-lg);
                border-radius: var(--radius-md);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .connection-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--accent-green);
                animation: connectionBlink 2s infinite;
                box-shadow: 0 0 8px currentColor;
            }

            .connection-dot.disconnected {
                background: var(--accent-red);
                animation: none;
            }

            @keyframes connectionBlink {
                0%,
                50% {
                    opacity: 1;
                }
                51%,
                100% {
                    opacity: 0.4;
                }
            }

            .last-message {
                max-width: 60%;
                text-align: center;
            }

            .message-text {
                font-size: 1.125rem;
                font-style: italic;
                font-weight: 500;
                color: var(--text-primary);
                background: var(--glass-bg);
                padding: var(--space-lg) var(--space-xl);
                border-radius: var(--radius-lg);
                border: 1px solid var(--accent-blue);
                backdrop-filter: blur(10px);
                box-shadow: 0 0 20px rgba(100, 217, 255, 0.15);
            }

            .time-up-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 87, 87, 0.95);
                backdrop-filter: blur(8px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                animation: timeUpPulse 1.5s infinite;
            }

            .time-up-text {
                font-size: 6rem;
                font-weight: 800;
                text-align: center;
                color: var(--text-primary);
                text-shadow: 0 0 40px rgba(255, 255, 255, 0.8);
                background: var(--glass-bg);
                padding: var(--space-2xl);
                border-radius: var(--radius-xl);
                border: 2px solid rgba(255, 255, 255, 0.3);
                backdrop-filter: blur(10px);
            }

            @keyframes timeUpPulse {
                0%,
                100% {
                    opacity: 0.95;
                    transform: scale(1);
                }
                50% {
                    opacity: 1;
                    transform: scale(1.02);
                }
            }

            .loading-screen {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--primary-bg);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            }

            .loading-spinner {
                width: 60px;
                height: 60px;
                border: 4px solid rgba(255, 255, 255, 0.1);
                border-left: 4px solid var(--accent-blue);
                border-top: 4px solid var(--accent-purple);
                border-radius: 50%;
                animation: modernSpin 1.5s linear infinite;
                margin-bottom: var(--space-2xl);
            }

            @keyframes modernSpin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .loading-text {
                font-size: 1.5rem;
                font-weight: 600;
                background: var(--gradient-primary);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            /* Notification overlay for hints and messages */
            .notification-overlay {
                position: fixed;
                top: 15%;
                left: 10%;
                right: 10%;
                background: var(--gradient-card);
                backdrop-filter: blur(20px);
                border: 2px solid var(--accent-blue);
                border-radius: var(--radius-xl);
                padding: var(--space-2xl);
                text-align: center;
                z-index: 1500;
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow:
                    var(--shadow-lg),
                    0 0 40px rgba(100, 217, 255, 0.2);
            }

            .notification-overlay.show {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            .notification-overlay.hint {
                border-color: var(--accent-yellow);
                box-shadow:
                    var(--shadow-lg),
                    0 0 40px rgba(255, 165, 2, 0.2);
            }

            .notification-overlay.quick-message {
                border-color: var(--accent-green);
                box-shadow:
                    var(--shadow-lg),
                    0 0 40px rgba(74, 222, 128, 0.2);
            }
            
            .notification-overlay.test {
                border-color: #4caf50;
                box-shadow:
                    var(--shadow-lg),
                    0 0 40px rgba(76, 175, 80, 0.2);
            }

            .notification-header {
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: var(--space-lg);
                background: var(--gradient-primary);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .notification-overlay.hint .notification-header {
                background: linear-gradient(
                    135deg,
                    var(--accent-yellow) 0%,
                    var(--accent-orange) 100%
                );
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .notification-overlay.quick-message .notification-header {
                background: linear-gradient(
                    135deg,
                    var(--accent-green) 0%,
                    var(--accent-blue) 100%
                );
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            .notification-overlay.test .notification-header {
                background: linear-gradient(
                    135deg,
                    #4caf50 0%,
                    #45a049 100%
                );
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .notification-content {
                font-size: 1.6rem;
                line-height: 1.5;
                color: var(--text-primary);
                font-weight: 600;
                letter-spacing: 0.01em;
            }

            /* Make hint text extra large on TV for readability */
            .notification-overlay.hint .notification-content {
                font-size: 2.2rem;
                line-height: 1.45;
            }
            
            .notification-overlay.test .notification-content {
                font-size: 1.8rem;
                line-height: 1.4;
                color: #e8f5e8;
            }

            .notification-close {
                position: absolute;
                top: var(--space-lg);
                right: var(--space-lg);
                font-size: 1.25rem;
                color: var(--text-muted);
                cursor: pointer;
                background: var(--surface-bg);
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .notification-close:hover {
                background: var(--card-bg);
                color: var(--text-primary);
                transform: scale(1.1);
            }
        </style>
    </head>
    <body>
        <div class="tv-container">
            <!-- Pantalla de carga -->
            <div class="loading-screen" id="loadingScreen">
                <div class="loading-spinner"></div>
                <div class="loading-text">Conectando al Game Master...</div>
            </div>

            <!-- Contenido principal -->
            <header class="tv-header">
                <h1 id="roomTitle">Sala 1</h1>
                <!-- Casting status hidden to reduce clutter on TV view -->
            </header>

            <main class="main-display">
                <!-- Overlay de tiempo agotado -->
                <div
                    class="time-up-overlay"
                    id="timeUpOverlay"
                    style="display: none"
                >
                    <div class="time-up-text">
                        Â¡TIEMPO<br />
                        AGOTADO!
                    </div>
                </div>

                <!-- Notification overlay for hints and messages -->
                <div class="notification-overlay" id="notificationOverlay">
                    <div
                        class="notification-close"
                        onclick="hideNotification()"
                    >
                        âœ•
                    </div>
                    <div class="notification-header" id="notificationHeader">
                        ðŸ§© NUEVA PISTA
                    </div>
                    <div
                        class="notification-content"
                        id="notificationContent"
                    ></div>
                </div>

                <div class="timer-display">
                    <div class="time-text" id="timeDisplay">60:00</div>
                    <div class="status-bar">
                        <div class="hints-display" id="hintsDisplay">
                            <span class="hint-icon">ðŸ§©</span>
                            <!-- Los puntos de pistas se generarÃ¡n dinÃ¡micamente -->
                        </div>
                    </div>
                </div>
            </main>

            <footer class="footer-bar">
                <div class="connection-status">
                    <div class="connection-dot" id="connectionDot"></div>
                    <span id="connectionText">Conectado</span>
                </div>
                <div class="last-message" id="lastMessage">
                    <!-- El Ãºltimo mensaje se mostrarÃ¡ aquÃ­ -->
                </div>
                <button
                    class="sound-toggle"
                    id="soundToggle"
                    onclick="toggleSound()"
                    title="Activar/Desactivar sonido"
                >
                    <span id="soundIcon">ðŸ”Š</span>
                </button>

            </footer>
        </div>

        <script type="module">
            import { io } from "https://cdn.socket.io/4.7.0/socket.io.esm.min.js";

            // Obtener parÃ¡metros de URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = parseInt(urlParams.get("room")) || 0;
            const isReceiver = urlParams.get("mode") === "receiver";

            // Elementos del DOM
            const loadingScreen = document.getElementById("loadingScreen");
            const roomTitle = document.getElementById("roomTitle");
            const timeDisplay = document.getElementById("timeDisplay");
            const hintsDisplay = document.getElementById("hintsDisplay");
            const connectionDot = document.getElementById("connectionDot");
            const connectionText = document.getElementById("connectionText");
            const lastMessage = document.getElementById("lastMessage");
            const timeUpOverlay = document.getElementById("timeUpOverlay");
            const notificationOverlay = document.getElementById(
                "notificationOverlay",
            );
            const notificationHeader =
                document.getElementById("notificationHeader");
            const notificationContent = document.getElementById(
                "notificationContent",
            );


            // Configurar conexiÃ³n Socket.IO
            const SERVER_URL =
                window.location.protocol +
                "//" +
                window.location.hostname +
                ":3001";
            const socket = io(SERVER_URL);

            let currentRoom = null;

            // Configurar informaciÃ³n de la sala inicial
            roomTitle.textContent = `Sala ${roomId + 1}`;

            // Funciones de utilidad
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, "0")}`;
            }

            function updateTimeDisplay(timeRemaining, isRunning) {
                timeDisplay.textContent = formatTime(timeRemaining);

                // Cambiar color segÃºn el tiempo restante
                timeDisplay.className = "time-text";
                if (timeRemaining <= 0) {
                    timeDisplay.classList.add("time-low");
                    timeUpOverlay.style.display = "flex";
                } else if (timeRemaining < 300) {
                    // 5 minutos
                    timeDisplay.classList.add("time-low");
                    timeUpOverlay.style.display = "none";
                } else if (timeRemaining < 900) {
                    // 15 minutos
                    timeDisplay.classList.add("time-warning");
                    timeUpOverlay.style.display = "none";
                } else {
                    timeDisplay.classList.add("time-normal");
                    timeUpOverlay.style.display = "none";
                }
            }

            function updateHintsDisplay(hintsRemaining, freeHintsCount = 3) {
                hintsDisplay.innerHTML = '<span class="hint-icon">ðŸ§©</span>';

                // Usar el nÃºmero original de pistas gratuitas como base para mostrar
                const maxHintsToShow = Math.max(freeHintsCount, hintsRemaining);
                const hintsToDisplay = Math.min(maxHintsToShow, 7); // MÃ¡ximo 7 para no sobrecargar la pantalla

                for (let i = 0; i < hintsToDisplay; i++) {
                    const dot = document.createElement("div");
                    dot.className = "hint-dot";

                    // Las pistas usadas se marcan como 'used'
                    if (i >= hintsRemaining) {
                        dot.classList.add("used");
                    }

                    // Marcar las pistas gratuitas con un estilo especial
                    if (i < freeHintsCount) {
                        dot.style.borderColor = "var(--accent-green)"; // Verde para pistas gratuitas
                    } else {
                        dot.classList.add("penalty");
                        dot.style.borderColor = "var(--accent-orange)"; // Naranja para pistas con penalizaciÃ³n
                    }

                    hintsDisplay.appendChild(dot);
                }

                // Si hay mÃ¡s pistas que las mostradas, agregar contador
                if (hintsRemaining > hintsToDisplay) {
                    const counter = document.createElement("span");
                    counter.textContent = `+${hintsRemaining - hintsToDisplay}`;
                    counter.style.marginLeft = "0.5rem";
                    counter.style.fontSize = "1.5rem";
                    hintsDisplay.appendChild(counter);
                }
            }

            function updateLastMessage(message) {
                if (message && message.trim()) {
                    lastMessage.innerHTML = `<div class="message-text">"${message}"</div>`;
                } else {
                    lastMessage.innerHTML = "";
                }
            }

            function updateConnectionStatus(connected) {
                connectionDot.className = "connection-dot";
                if (connected) {
                    connectionText.textContent = "Conectado";
                } else {
                    connectionDot.classList.add("disconnected");
                    connectionText.textContent = "Desconectado";
                }
            }

            function updateRoomData(room) {
                if (room && room.id === roomId) {
                    currentRoom = room;

                    // Update room name
                    if (room.name) {
                        roomTitle.textContent = room.name;
                    }

                    updateTimeDisplay(room.timeRemaining, room.isRunning);
                    updateHintsDisplay(
                        room.hintsRemaining,
                        room.freeHintsCount || 3,
                    );
                    updateLastMessage(room.lastMessage);
                }
            }

            // Notification system functions
            function showNotification(type, content, title) {
                // Try enabling audio whenever we show a notification (works on receiver, harmless on sender)
                enableAudio();
                notificationOverlay.className = `notification-overlay ${type}`;
                notificationHeader.textContent = title;
                notificationContent.textContent = content;

                // Show notification
                setTimeout(() => {
                    notificationOverlay.classList.add("show");
                }, 100);

                // Auto-hide after different times based on type
                const autoHideTime = type === 'test' ? 3000 : 8000;
                setTimeout(() => {
                    hideNotification();
                }, autoHideTime);
            }

            function hideNotification() {
                notificationOverlay.classList.remove("show");
            }

            function showHint(hintText, timePenaltyApplied = false) {
                const title = timePenaltyApplied
                    ? "ðŸ§© PISTA (-2 min)"
                    : "ðŸ§© NUEVA PISTA";
                showNotification("hint", hintText, title);
                
                // Only play sound if sound is enabled
                if (soundEnabled) {
                    playHintSound();
                }
            }

            function showQuickMessage(message) {
                showNotification(
                    "quick-message",
                    message,
                    "ðŸ’¬ MENSAJE DEL GAME MASTER",
                );
                
                // Only play sound if sound is enabled
                if (soundEnabled) {
                    playMessageSound();
                }
            }

            // Sound generation and playback functions
            let audioContext = null;
            let soundEnabled = true;

            function initAudioContext() {
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        console.log("ðŸ”Š Audio context created, state:", audioContext.state);
                    } catch (error) {
                        console.warn("âŒ Web Audio API not supported:", error);
                        soundEnabled = false;
                        return;
                    }
                }
                
                // Attempt to resume immediately (works on Chromecast receiver)
                if (audioContext && audioContext.state === 'suspended') {
                    console.log("ðŸ”Š Audio context suspended, attempting to resume...");
                    audioContext.resume().then(() => {
                        console.log("ðŸ”Š Audio context resumed successfully, state:", audioContext.state);
                    }).catch((error) => {
                        console.warn("âŒ Failed to resume audio context:", error);
                    });
                } else {
                    console.log("ðŸ”Š Audio context state:", audioContext.state);
                }
            }

            function createBeepSound(
                frequency = 800,
                duration = 0.3,
                volume = 0.3,
                type = "sine",
            ) {
                if (!soundEnabled || !audioContext) return;

                try {
                    // Create oscillator and gain nodes
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    // Connect nodes
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    // Configure oscillator
                    oscillator.frequency.setValueAtTime(
                        frequency,
                        audioContext.currentTime,
                    );
                    oscillator.type = type;

                    // Configure gain (volume envelope)
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(
                        volume,
                        audioContext.currentTime + 0.01,
                    );
                    gainNode.gain.exponentialRampToValueAtTime(
                        0.001,
                        audioContext.currentTime + duration,
                    );

                    // Start and stop the sound
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);

                    // Clean up
                    oscillator.onended = () => {
                        oscillator.disconnect();
                        gainNode.disconnect();
                    };
                } catch (error) {
                    console.warn("âŒ Error playing sound:", error);
                }
            }

            function playHintSound() {
                initAudioContext();
                if (!soundEnabled || !audioContext) return;

                // Play a pleasant two-tone chime for hints
                // Higher frequency first tone
                createBeepSound(880, 0.15, 0.3, "sine");

                // Lower frequency second tone with slight delay
                setTimeout(() => {
                    createBeepSound(660, 0.25, 0.4, "sine");
                }, 120);

                console.log("ðŸ”Š Playing hint notification sound");
            }

            function playMessageSound() {
                initAudioContext();
                if (!soundEnabled || !audioContext) return;

                // Play a softer single tone for messages
                createBeepSound(523, 0.2, 0.25, "triangle");

                console.log("ðŸ”Š Playing message notification sound");
            }

            // Initialize audio context on first user interaction
            function enableAudio() {
                console.log("ðŸ”Š Enabling audio...");
                initAudioContext();
                if (audioContext) {
                    if (audioContext.state === 'suspended') {
                        console.log("ðŸ”Š Audio context suspended, resuming...");
                        audioContext.resume().then(() => {
                            console.log('ðŸ”Š Audio context resumed successfully');
                            // Test audio after resume
                            testAudio();
                        }).catch((error) => {
                            console.warn('âŒ Failed to resume audio context:', error);
                        });
                    } else {
                        console.log('ðŸ”Š Audio context already active, testing audio...');
                        testAudio();
                    }
                } else {
                    console.warn('âŒ No audio context available');
                }
            }
            
            // Test audio functionality
            function testAudio() {
                try {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    gain.gain.value = 0.00001; // Very low volume
                    osc.frequency.value = 440; // A4 note
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.start();
                    setTimeout(() => { 
                        osc.stop(); 
                        osc.disconnect(); 
                        gain.disconnect(); 
                        console.log('ðŸ”Š Audio test completed');
                    }, 30);
                } catch (error) {
                    console.warn('âŒ Audio test failed:', error);
                }
            }

            // Add click listener to enable audio (required for autoplay policy)
            document.addEventListener("click", enableAudio, { once: true });
            document.addEventListener("touchstart", enableAudio, { once: true });
            document.addEventListener("pointerdown", enableAudio, { once: true });
            document.addEventListener("keydown", enableAudio, { once: true });

            // Sound toggle functionality
            function toggleSound() {
                soundEnabled = !soundEnabled;
                const soundToggle = document.getElementById("soundToggle");
                const soundIcon = document.getElementById("soundIcon");

                if (soundEnabled) {
                    soundToggle.classList.remove("muted");
                    soundIcon.textContent = "ðŸ”Š";
                    soundToggle.title = "Desactivar sonido";
                    console.log("ðŸ”Š Sound notifications enabled");

                    // Play a test sound to confirm
                    initAudioContext();
                    if (audioContext) {
                        createBeepSound(523, 0.1, 0.2, "sine");
                    }
                } else {
                    soundToggle.classList.add("muted");
                    soundIcon.textContent = "ðŸ”‡";
                    soundToggle.title = "Activar sonido";
                    console.log("ðŸ”‡ Sound notifications disabled");
                }

                // Save preference to localStorage
                localStorage.setItem("tvSoundEnabled", soundEnabled);
            }

            // Load sound preference from localStorage
            function loadSoundPreference() {
                const saved = localStorage.getItem("tvSoundEnabled");
                if (saved !== null) {
                    soundEnabled = saved === "true";
                    const soundToggle = document.getElementById("soundToggle");
                    const soundIcon = document.getElementById("soundIcon");

                    if (!soundEnabled) {
                        soundToggle.classList.add("muted");
                        soundIcon.textContent = "ðŸ”‡";
                        soundToggle.title = "Activar sonido";
                    }
                }
            }

            // Initialize sound preference on load
            loadSoundPreference();

            // Make toggleSound globally accessible
            window.toggleSound = toggleSound;
            
            // Fetch initial room data
            async function fetchInitialRoomData() {
                try {
                    const response = await fetch(
                        `${SERVER_URL}/api/rooms/${roomId}`,
                    );
                    if (response.ok) {
                        const room = await response.json();
                        updateRoomData(room);
                        console.log("ðŸ“Š Room data loaded:", room);
                    }
                } catch (error) {
                    console.error("âŒ Error fetching room data:", error);
                }
            }

            // Event listeners de Socket.IO
            socket.on("connect", () => {
                console.log("âœ… Conectado al servidor");
                updateConnectionStatus(true);
                loadingScreen.style.display = "none";

                // Join the specific room for this TV window
                socket.emit('join-tv-room', roomId);
                console.log(`ðŸ“º TV window joined room ${roomId}`);

                // Fetch current room data when connected
                fetchInitialRoomData();
            });

            socket.on("disconnect", () => {
                console.log("âŒ Desconectado del servidor");
                updateConnectionStatus(false);
                loadingScreen.style.display = "flex";
                loadingScreen.querySelector(".loading-text").textContent =
                    "Reconectando...";
            });

            socket.on("reconnect", () => {
                console.log("ðŸ”„ Reconectado al servidor");
                updateConnectionStatus(true);
                loadingScreen.style.display = "none";

                // Re-fetch room data after reconnection
                fetchInitialRoomData();
            });

            socket.on("initial-state", (gameState) => {
                console.log("ðŸ“Š Estado inicial recibido");
                const room = gameState.rooms.find((r) => r.id === roomId);
                if (room) {
                    updateRoomData(room);
                }
            });

            socket.on("room-updated", (room) => {
                updateRoomData(room);
            });

            socket.on("time-sync", (data) => {
                if (data.roomId === roomId) {
                    updateTimeDisplay(data.timeRemaining, data.isRunning);
                }
            });

            socket.on("hint-sent", (data) => {
                console.log("ðŸ’¡ Evento hint-sent recibido:", data);
                console.log("ðŸ’¡ Room ID en evento:", data.roomId, "Room ID de esta ventana:", roomId);
                console.log("ðŸ’¡ Tipo de hint:", data.hintId || 'unknown');
                
                if (data.roomId === roomId) {
                    console.log("ðŸ’¡ Pista recibida para esta sala:", data.hint);
                    showHint(data.hint, data.timePenaltyApplied);
                } else {
                    console.log("âš ï¸ Pista recibida para otra sala:", data.roomId, "esta sala:", roomId);
                }
            });

            socket.on("message-sent", (data) => {
                console.log("ðŸ’¬ Evento message-sent recibido:", data);
                if (data.roomId === roomId) {
                    console.log("ðŸ’¬ Mensaje recibido para esta sala:", data.message);
                    updateLastMessage(data.message);

                    // Show notification for quick messages
                    if (data.isQuickMessage) {
                        showQuickMessage(data.message);
                    }
                } else {
                    console.log("âš ï¸ Mensaje recibido para otra sala:", data.roomId, "esta sala:", roomId);
                }
            });

            socket.on("room-reset", (resetRoomId) => {
                if (resetRoomId === roomId) {
                    console.log("ðŸ”„ Sala reiniciada");

                    // Reset all visual states
                    timeUpOverlay.style.display = "none";

                    // Clear last message
                    updateLastMessage("");

                    // Fetch fresh room data to ensure sync
                    fetchInitialRoomData();

                    console.log("âœ… Chrome Cast window reset completed");
                }
            });
            
            // Test event listener to verify server communication
            socket.on("test-event", (data) => {
                console.log("ðŸ§ª Test event received:", data);
                if (data.roomId === roomId) {
                    console.log("âœ… Test event matches this room, communication working!");
                    // Show a brief test notification
                    showNotification("test", "Test event received successfully", "ðŸ§ª TEST");
                }
            });

            // Global function for notification close button
            window.hideNotification = hideNotification;

            // Inicializar conexiÃ³n
            socket.connect();
        </script>

        <!-- Audio elements for sound notifications -->
        <audio id="hintSound" preload="auto" volume="0.7">
            <!-- Pleasant notification sound for hints (base64 encoded) -->
        </audio>

        <audio id="messageSound" preload="auto" volume="0.5">
            <!-- Softer sound for messages (base64 encoded) -->
        </audio>
    </body>
</html>
